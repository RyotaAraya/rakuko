# 労働時間計算仕様書

## 基本ルール

### 1. 学生アルバイトの労働制限
- **週20時間制限**：実労働時間が週20時間以下
- **掛け持ち制限**：他バイトとの合計実労働時間が週40時間以下
- **実労働時間** = 勤務時間 - 休憩時間（6時間以上勤務時は1時間休憩を自動差し引き）

### 2. シフト提出時のルール
- **入力項目**：始業時間と終業時間のみ
- **休憩時間は入力しない**（面倒なため）
- **6時間以上勤務**：システムが自動で1時間休憩を差し引いて実労働時間を計算
- **6時間未満勤務**：休憩なしとして実労働時間 = 勤務時間

### 3. 勤怠登録時のルール
- **出勤・退勤・休憩開始/終了**：ボタンでリアルタイム記録
- **複数回休憩可能**：累計休憩時間で計算
- **休憩記録忘れ**：手動入力も可能
- **実労働時間** = 出勤〜退勤時間 - 累計休憩時間

## シフト提出時の計算例

### ケース1：7時間勤務 × 3日
```
入力：
月曜: 9:00-16:00 (7時間勤務)
水曜: 9:00-16:00 (7時間勤務)
金曜: 9:00-16:00 (7時間勤務)

システム計算：
月曜: 7時間 - 1時間(自動休憩) = 6時間実労働
水曜: 7時間 - 1時間(自動休憩) = 6時間実労働
金曜: 7時間 - 1時間(自動休憩) = 6時間実労働
週合計: 18時間実労働 ✓ (20時間以下)
```

### ケース2：8時間勤務 × 3日
```
入力：
月曜: 9:00-17:00 (8時間勤務)
水曜: 9:00-17:00 (8時間勤務)
金曜: 9:00-17:00 (8時間勤務)

システム計算：
月曜: 8時間 - 1時間(自動休憩) = 7時間実労働
水曜: 8時間 - 1時間(自動休憩) = 7時間実労働
金曜: 8時間 - 1時間(自動休憩) = 7時間実労働
週合計: 21時間実労働 ❌ (20時間超過)
```

### ケース3：短時間勤務
```
入力：
月曜: 9:00-14:00 (5時間勤務)
水曜: 9:00-15:00 (6時間勤務)
金曜: 9:00-13:00 (4時間勤務)

システム計算：
月曜: 5時間実労働 (6時間未満なので休憩差し引きなし)
水曜: 6時間 - 1時間(自動休憩) = 5時間実労働
金曜: 4時間実労働 (6時間未満なので休憩差し引きなし)
週合計: 14時間実労働 ✓
```

## 勤怠登録時の計算例

### ケース1：予定通り勤務
```
シフト予定: 9:00-16:00 (予定実労働6時間)
実際勤怠:
- 出勤: 9:00
- 休憩: 12:00-13:00 (1時間)
- 退勤: 16:00
実労働時間: 7時間 - 1時間 = 6時間 ✓
```

### ケース2：複数回休憩
```
シフト予定: 9:00-17:00 (予定実労働7時間)
実際勤怠:
- 出勤: 9:00
- 休憩1: 12:00-12:30 (30分)
- 休憩2: 15:00-15:45 (45分)
- 退勤: 17:00
実労働時間: 8時間 - 1時間15分 = 6時間45分
```

## システムチェック項目

### シフト提出時
- [ ] 勤務時間6時間以上の場合、自動で1時間休憩を差し引き
- [ ] 週合計実労働時間が20時間以下かチェック
- [ ] 掛け持ちバイトとの合計が40時間以下かチェック
- [ ] 制限超過時は提出ボタン無効化

### 勤怠登録時
- [ ] 出勤〜退勤時間から累計休憩時間を差し引いて実労働時間計算
- [ ] 実績労働時間をリアルタイム更新
- [ ] 残りシフト予定時間 + 実績労働時間で週20時間超過予測
- [ ] 超過予測時は事前警告表示
- [ ] 実際に20時間超過時は重要警告表示

## 週労働時間予測ロジック

### 計算式
```
今週の予測労働時間 = 実績労働時間 + 残りシフト予定時間

実績労働時間 = すでに勤務完了した日の実労働時間の合計
残りシフト予定時間 = まだ勤務していない日のシフト予定実労働時間の合計
```

### 予測例
```
【今週のシフト予定】
月曜: 9:00-16:00 → 予定実労働6時間
水曜: 9:00-16:00 → 予定実労働6時間
金曜: 9:00-16:00 → 予定実労働6時間
週予定合計: 18時間

【水曜日の勤怠登録中】
月曜実績: 6.5時間 (実際に勤務完了)
水曜現在: 3時間 (勤務中、まだ完了していない)
金曜予定: 6時間 (未勤務)

予測労働時間 = 6.5時間(月曜実績) + 6時間(金曜予定) + 水曜の最終予測時間
→ 水曜が7時間になりそうなら 6.5 + 7 + 6 = 19.5時間
→ 水曜が8時間になりそうなら 6.5 + 8 + 6 = 20.5時間 ⚠️超過予測
```

## 月末締め作業管理

### 外部ツール連携仕様
- **ジョブカン**：交通費申請
- **ラクロー**：勤怠締め作業
- 本アプリは各ツールでの作業完了確認のみを管理

### 月末締め作業フロー
1. **学生の作業**
   - ジョブカンで交通費申請を完了
   - ラクローで勤怠締め作業を完了
   - 本アプリで完了チェックを入力

2. **部署担当者の確認**
   - 学生の完了チェック状況を確認
   - ジョブカン・ラクローで実際の作業状況を目視確認
   - 本アプリで承認処理

3. **労務担当者の最終確認**
   - 部署担当者の承認状況を確認
   - ジョブカン・ラクローで最終確認
   - 本アプリで最終承認

### チェック項目
- **ジョブカン交通費申請完了**：チェックボックス
- **ラクロー締め完了**：チェックボックス
- **外部ツールリンク**：各ツールへの直接リンク表示

### リマインド機能
- **表示タイミング**：常時表示（ダッシュボード）
- **必須入力日**：毎月最終出社日
- **リマインド方法**：Slack通知
- **対象者**：未完了の学生、未承認の管理者
- **締切後処理**：過ぎてもやむなし（記録は残す）

### 承認フロー
```
学生チェック → 部署担当者承認 → 労務担当者最終承認
   ↓              ↓                ↓
外部ツール確認  外部ツール目視確認  外部ツール最終確認
```

## 画面表示形式

### 月末締め作業画面
```
【今月の締め作業】2024年3月
締切日: 3月29日（最終出社日）

□ ジョブカン交通費申請完了 [ジョブカンを開く]
□ ラクロー締め完了 [ラクローを開く]

[完了報告] ← 両方チェック後に有効化

ステータス: 未完了
部署承認: 待機中
労務承認: 待機中
```

### シフト希望画面
```
【今週のシフト希望】
月曜: 9:00-16:00 → 実労働6時間 (7時間勤務-1時間休憩)
水曜: 9:00-16:00 → 実労働6時間 (7時間勤務-1時間休憩)
金曜: 9:00-16:00 → 実労働6時間 (7時間勤務-1時間休憩)

週予定実労働時間: 18時間 / 20時間 ✓
掛け持ちバイト: 15時間
総合計実労働時間: 33時間 / 40時間 ✓
```

### 勤怠登録画面（勤務中）
```
【今日の勤怠】
出勤: 09:00 (3時間経過)
休憩: 12:00-13:00 (1時間)
現在実労働時間: 2時間

【今週の状況】
実績労働時間: 12.5時間 (月6.5h + 火6h + 今日2h)
残り予定時間: 6時間 (金曜予定)
予測合計: 18.5時間 / 20時間

⚠️ 今日8時間勤務なら週20.5時間となり制限超過予定
```

### 勤怠登録画面（完了後）
```
【今日の勤怠】
出勤: 09:00
休憩: 12:00-13:00 (1時間)
退勤: 16:00
実労働時間: 6時間

【今週の累計】
実績労働時間: 18時間 / 20時間 ✓
残り予定時間: 6時間 (金曜)
予測合計: 24時間 ❌ 制限超過予定！
```

## 実装時の追加仕様・改善点（フェーズ3-5実装）

### タイムゾーン設定
- **設定値**: `config.time_zone = "Tokyo"`
- **理由**: 打刻時刻がUTCで保存されると日本時間と9時間ずれる問題を解決
- **影響範囲**: すべての時刻データが日本時間で一貫して扱われる

### 打刻ボタンUI改善
**状態管理の実装**
- 初期ローディング状態: すべてのボタンをグレーアウト
- データ取得完了後: 状態に応じてボタンの活性/非活性を制御

**視覚的フィードバック**
- 活性時: 青（出勤）・緑（休憩開始）・黄（休憩終了）・赤（退勤）
- 非活性時: グレー背景 + グレーテキスト（bg-gray-300 text-gray-500）
- トランジション: 色変化にスムーズなアニメーション適用

**状態別のボタン制御**
```
初期状態（未出勤）:
  ✓ 出勤のみ可能
  ✗ 休憩開始・休憩終了・退勤は不可

勤務中（出勤後）:
  ✗ 出勤は不可（既に出勤済み）
  ✓ 休憩開始・退勤が可能
  ✗ 休憩終了は不可（休憩していない）

休憩中:
  ✗ 出勤・休憩開始・退勤は不可
  ✓ 休憩終了のみ可能

退勤後:
  ✗ すべてのボタンが不可
```

### 複数回休憩の実装
**仕様**
- 休憩は1日に複数回取得可能
- 各休憩に`break_sequence`（1, 2, 3...）を自動採番
- 累計休憩時間を自動計算

**例**
```
休憩1: 12:00-12:30 (30分) → break_sequence: 1
休憩2: 15:00-15:45 (45分) → break_sequence: 2
累計休憩時間: 1時間15分
```

### TOPページへの統合
**変更内容**
- TOPページ（`/`）に勤怠登録UIを統合
- 専用ページ（`/attendances/today`）と同じAttendanceTodayコンポーネントを使用
- 同じAPIを共有し、機能的に完全に同一

**UX改善の意図**
- 毎日使う勤怠登録をTOPページから直接実行可能
- 専用ページへの遷移が不要になり、操作手順を削減

### 週間労働時間予測の実装
**表示項目**
- 実績労働時間: 今週すでに完了した勤務の合計
- 残り予定時間: まだ勤務していない日のシフト予定合計
- 予測合計: 実績 + 残り予定

**制限チェック**
- 20時間制限超過予測時に赤文字で警告表示
- 制限内の場合は緑色で「制限内です」と表示

### 勤怠一覧画面の実装
**3種類の一覧画面**

1. **今日の勤怠** (`/attendances/today`)
   - リアルタイムで打刻状況を表示
   - 今週の労働時間予測を表示

2. **週間勤怠一覧** (`/attendances/weekly`)
   - 1週間分の勤怠記録を日別表示
   - 週間集計（総労働時間・出勤日数・平均）
   - 前週・今週・次週へのナビゲーション
   - 20時間制限チェック結果

3. **月別勤怠一覧** (`/attendances`)
   - 月間の勤怠記録を日別表示
   - 月間集計（総労働時間・出勤日数・平均・承認待ち件数）
   - 前月・今月・次月へのナビゲーション
   - 詳細ページへのリンク

4. **勤怠詳細** (`/attendances/:id`)
   - 1日の勤怠詳細情報
   - 打刻履歴の完全表示
   - 制限違反チェック結果

### APIエンドポイント
**TimeRecordsController**
- `POST /time_records/clock_in` - 出勤打刻
- `POST /time_records/clock_out` - 退勤打刻
- `POST /time_records/break_start` - 休憩開始打刻
- `POST /time_records/break_end` - 休憩終了打刻
- `GET /time_records/today` - 今日の打刻記録取得

**AttendancesController**
- `GET /attendances/today` - 今日の勤怠画面
- `GET /attendances/weekly` - 週間勤怠一覧
- `GET /attendances` - 月別勤怠一覧
- `GET /attendances/:id` - 勤怠詳細

### 退勤時の自動処理
**Attendanceレコード自動生成**
- 退勤打刻時にAttendanceレコードを自動作成
- TimeRecordから実労働時間と休憩時間を自動計算
- ステータスは`pending`（承認待ち）で作成

## シフト提出機能との連携

### 週の定義
- **週の範囲**: 月曜日〜日曜日（ISO 8601準拠）
- **月跨ぎ対応**: 前月確定データ + 当月入力データで週制限チェック
- **計算範囲**: 週に含まれる全日程（月跨ぎ含む）を週単位で集計

### 労働時間二重チェック
- **弊社20時間制限**: 弊社での実労働時間上限（学生バイト法的制限）
- **週40時間制限**: 弊社 + 掛け持ちの合計上限（労働基準法制限）
- **独立検証**: 両制限を独立して検証し、どちらか一方でも超過なら警告
- **休憩自動控除**: 6時間以上勤務の場合、1時間の休憩を自動差し引き

### シフト提出時の入力制限
- **時間範囲**:
  - 弊社勤務: 09:00〜18:00
  - 掛け持ちバイト: 00:00〜23:45
- **入力制限**:
  - 対象月外の日付は入力不可（弊社・掛け持ち共通）
  - 弊社勤務は土日入力不可（平日のみ）
- **時間順序**: 開始時間 < 終了時間の検証
- **入力形式**: セレクトボックス（15分刻み）

### リアルタイム計算とバリデーション
**シフト提出画面**
- 週単位で弊社時間 + 掛け持ち時間をリアルタイム計算
- 制限超過時に赤色警告を表示
- 制限超過時は提出ボタン無効化

**勤怠登録画面**
- 今週の実績労働時間をリアルタイム表示
- 残りシフト予定時間との合計で週20時間超過予測
- 超過予測時に警告を事前表示

### 月跨ぎ週の処理
**例: 第44週（10/27-11/2）の処理**
```
10月提出時:
- 対象日: 10/27, 10/28, 10/29, 10/30, 10/31
- ステータス: submitted（提出済み）
- 実労働時間: 14時間（弊社） + 12時間（掛け持ち） = 26時間

11月提出時:
- 対象日: 11/01, 11/02
- 前月提出済みデータ（10月分）: 26時間
- 当月入力データ（11月分）: 新規入力
- 週制限チェック: 前月26時間 + 当月入力時間 ≤ 40時間
```

### データ管理
**シフト予定データ（ShiftRequest）**
- 月単位で提出・管理
- 開始時間・終了時間を記録
- 6時間以上勤務時は自動で1時間休憩を控除して実労働時間を計算
- ステータス管理: draft → submitted（提出後も再編集可能、承認不要）

**勤怠実績データ（Attendance + TimeRecord）**
- 日単位で打刻・記録
- TimeRecord: 出勤・退勤・休憩開始/終了の打刻履歴
- Attendance: 退勤時に自動生成される日次勤怠レコード
- 複数回休憩の累計時間を実労働時間から控除

### 承認フロー（AASM状態管理）

**AASM（Acts As State Machine）による状態管理**
- Application、Attendance、Approvalの各モデルでAASM gemを使用
- 状態遷移を明示的に定義し、不正な状態変更を防止
- イベント駆動で状態変更を管理

```
【シフト予定（WeeklyShift）】
draft → submitted
   ↓         ↓
 編集可能   提出済み（再編集可能）

状態遷移:
- submit: draft → submitted
- back_to_draft: submitted → draft（再編集のため）

シンプルなフロー:
1. 学生が submit! イベントで提出 → submitted
2. 制限内であれば何度でも back_to_draft! で下書きに戻せる
3. 再度 submit! で提出可能
4. 承認は不要（学業優先のため柔軟に変更可能）

【勤怠実績（Attendance）】
pending → approved/rejected
   ↓          ↓
部署承認待ち  最終承認

状態遷移:
- approve: pending → approved
- reject: pending → rejected

承認フロー:
1. 退勤打刻時にAttendanceレコード自動生成（status: pending）
2. 部署承認レコードが自動生成（status: pending）
3. 部署担当者が Approval.approve! → Approval.status: approved
4. Approval.after_approve コールバック → Attendance.check_and_update_status!
5. Attendance.approve! → status: approved

【各種申請（Application）】
draft → pending → approved/rejected
  ↓       ↓           ↓
下書き  承認待ち   最終承認

状態遷移:
- submit: draft → pending
- approve_final: pending → approved
- reject_final: pending → rejected
- return_to_draft: pending → draft

承認フロー:
1. 学生が submit! イベントで提出 → pending
2. 部署承認レコードが自動生成（status: pending）
3. 部署担当者が Approval.approve! → Approval.status: approved
4. 部署承認完了後、Application.check_and_update_status! → approved

【Approval（承認レコード）】
pending → approved/rejected
   ↓          ↓
承認待ち   承認完了

状態遷移:
- approve: pending → approved (after: after_approve)
- reject: pending → rejected (after: after_reject)

AASM コールバック:
- after_approve: approved_at更新 + approvable.check_and_update_status!
- after_reject: approved_at更新 + approvable.check_and_update_status!
```

**承認システムの特徴**
- **Application（各種申請）**: 部署担当者の承認のみで完了
- **Attendance（勤怠）**: 部署担当者の承認のみで完了
- 部署担当者が却下（rejected）した時点で、approvable全体がrejected
- 部署担当者が承認（approved）した時点で、approvable全体がapproved
- **シフト予定は承認不要**（学業優先のため制限内であれば自由に変更可能）

**状態チェックメソッド**
```ruby
# Application（欠勤・遅刻・早退申請）
application.check_and_update_status!
# 部署・労務両方が承認済みなら approve_final!
# どちらかが却下なら reject_final!

# Attendance（勤怠実績）
attendance.check_and_update_status!
# 部署承認のみチェック
# 承認済みなら approve!
# 却下なら reject!

# WeeklyShift（シフト予定）
# 承認不要 - 制限チェックのみ実施
```

### 掛け持ちバイトの実績管理方針

**基本方針**: 掛け持ちバイトの実績記録は行わず、**予定時間を実績として扱う**

**理由**:
- 掛け持ち先の勤務時間を毎回記録する労力が非常に大きい
- 管理コストに見合う効果が見込めない
- 週40時間制限チェックの目的は達成できる

**実装**:
- `Attendance.calculate_sidejob_hours`: WeeklyShiftのDailyScheduleから予定時間を取得
- シフト提出時の予定時間をそのまま実績値として週次労働時間計算に使用
- 労働時間予測も予定時間ベースで正確に計算可能
```