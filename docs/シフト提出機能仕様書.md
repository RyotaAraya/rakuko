# 📋 シフト提出機能 仕様書

## 📝 概要

学生アルバイトが月間シフト希望を提出する機能。労働基準法遵守のため、週20時間（自社）+ 掛け持ち40時間制限をリアルタイムチェックする。

## 👥 ユーザーストーリー

**AS A** 学生アルバイト
**I WANT TO** シフト希望を簡単に提出し、制限を超えないように確認したい
**SO THAT** 労働基準法を遵守しながら効率的に働ける

## 🎯 機能要件

### 1. シフト入力機能

#### 1.1 月間カレンダー表示
- **週単位表示**: 月を5週に分割して表示
- **日付表示**: 各日の曜日と日付を明示
- **時間入力**: セレクトボックスによる時刻選択（15分刻み）

#### 1.2 勤務時間入力
- **入力形式**:
  - セレクトボックス（15分刻み）
  - 初期表示: `--`（未選択状態）
- **時間範囲**:
  - 弊社勤務: 09:00〜18:00
  - 掛け持ちバイト: 00:00〜23:45
- **入力制限**:
  - **対象月外**: 前月・翌月の日付は入力不可（弊社・掛け持ち共通）
  - **土日制限**: 弊社勤務のみ土日は入力不可
- **弊社勤務**:
  - 開始時間・終了時間を個別入力
  - 実労働時間計算: 6時間以上は1時間休憩自動差し引き
- **掛け持ちバイト**:
  - 開始時間・終了時間を個別入力
  - 実労働時間計算: 同様に休憩時間を考慮

#### 1.3 一括入力機能
- **対象**: 全週の月〜金曜日に同じ時間を一括設定
- **入力方法**: プロンプトダイアログで開始・終了時間を入力
- **適用範囲**: 弊社勤務のみ（掛け持ちは個別入力）

#### 1.4 リアルタイム計算
- **週単位計算**: 各週の弊社時間 + 掛け持ち時間
- **制限チェック**: 週40時間制限の可視化
- **警告表示**: 制限超過時の赤色警告

### 2. バリデーション機能

#### 2.1 労働時間制限
- **週20時間制限**: 弊社での実労働時間上限（学生バイト法的制限）
- **週40時間制限**: 弊社 + 掛け持ちの合計上限（労働基準法制限）
- **二重チェック**: 両方の制限を独立して検証
- **実労働時間計算**:
  - 6時間未満: 実働時間 = 勤務時間
  - 6時間以上: 実働時間 = 勤務時間 - 1時間（休憩）

#### 2.2 入力検証
- **必須入力**: 開始時間と終了時間のペア
- **時間順序**: 開始 < 終了の検証
- **重複チェック**: 弊社と掛け持ちの時間重複検証

### 3. 提出・保存機能

#### 3.1 下書き保存
- **自動保存**: 入力変更時の自動保存
- **手動保存**: 下書き保存ボタン
- **復元機能**: 前回入力内容の復元

#### 3.2 正式提出
- **制限チェック**: 提出前の最終検証
- **確認ダイアログ**: 制限超過時の確認
- **提出状態管理**: 提出後も再編集可能（学業優先のため）

## 🗃️ データ構造（週中心設計）

### 1. 週中心テーブル設計

#### weeks テーブル（新規）
```ruby
# 週の基本情報
create_table "weeks" do |t|
  t.date "start_date", null: false     # 週開始日（月曜日）
  t.date "end_date", null: false       # 週終了日（日曜日）
  t.integer "year"                     # 年
  t.integer "week_number"              # 年内週番号
  t.boolean "is_cross_month"           # 月跨ぎ週フラグ
  t.timestamps
end
```

#### weekly_shifts テーブル（新規）
```ruby
# ユーザーの週間シフト
create_table "weekly_shifts" do |t|
  t.bigint "user_id", null: false
  t.bigint "week_id", null: false
  t.integer "submission_month"         # 提出対象月
  t.integer "submission_year"          # 提出対象年
  t.integer "status"                   # draft, submitted（再編集可能）
  t.text "violation_warnings"          # 制限違反警告
  t.datetime "submitted_at"            # 提出日時
  t.timestamps
end
```

#### daily_schedules テーブル（新規）
```ruby
# 日別スケジュール詳細
create_table "daily_schedules" do |t|
  t.bigint "weekly_shift_id", null: false
  t.date "date"                        # 対象日
  t.string "company_start_time", limit: 8   # 弊社開始時間（HH:MM形式）
  t.string "company_end_time", limit: 8     # 弊社終了時間（HH:MM形式）
  t.string "sidejob_start_time", limit: 8   # 掛け持ち開始時間（HH:MM形式）
  t.string "sidejob_end_time", limit: 8     # 掛け持ち終了時間（HH:MM形式）
  t.boolean "is_company_working"       # 弊社勤務フラグ
  t.boolean "is_sidejob_working"       # 掛け持ちフラグ
  t.timestamps
end
```

**重要な設計判断: 時刻データをstring型で保存**
- PostgreSQLのtime型ではなく、string型（limit: 8）でHH:MM形式の文字列として保存
- 理由: time型を使用すると、Railsのタイムゾーン設定により自動的にUTC/JSTの変換が発生し、「08:00」が「17:00」になるなどの問題が発生
- シフト希望の「時刻」は日付に依存しない純粋な時間情報であり、タイムゾーン概念が不要
- 入力値"08:00"がそのまま"08:00"として保存・表示されるため、実装が単純かつ直感的

#### monthly_summaries テーブル（新規）
```ruby
# 月次集計情報
create_table "monthly_summaries" do |t|
  t.bigint "user_id", null: false
  t.integer "year"
  t.integer "month"
  t.decimal "total_company_hours", precision: 5, scale: 2
  t.decimal "total_sidejob_hours", precision: 5, scale: 2
  t.decimal "total_all_hours", precision: 5, scale: 2
  t.integer "status"                   # draft, submitted（再編集可能）
  t.timestamps
end
```

### 2. 週中心データ保存仕様

#### 2.1 週間シフト作成
```ruby
# 1. 対象月の週を取得
target_date = Date.new(2025, 10, 1)
weeks_in_month = Week.for_month(target_date.year, target_date.month)

# 2. ユーザーの週間シフト作成
weeks_in_month.each do |week|
  weekly_shift = WeeklyShift.create!(
    user: current_user,
    week: week,
    submission_month: target_date.month,
    submission_year: target_date.year,
    status: :draft
  )

  # 3. 各日のスケジュール作成
  (week.start_date..week.end_date).each do |date|
    # 提出対象月の日付のみ作成
    if date.month == target_date.month
      weekly_shift.daily_schedules.create!(
        date: date,
        company_start_time: company_times[date][:start],
        company_end_time: company_times[date][:end],
        sidejob_start_time: sidejob_times[date][:start],
        sidejob_end_time: sidejob_times[date][:end],
        is_company_working: company_working_days.include?(date),
        is_sidejob_working: sidejob_working_days.include?(date)
      )
    end
  end
end

# 4. 月次サマリー作成
MonthlySummary.create!(
  user: current_user,
  year: target_date.year,
  month: target_date.month,
  status: :draft
)
```

#### 2.2 週間制限チェック結果（月跨ぎ対応）
```ruby
# violation_warnings に JSON で保存（二重チェック対応）
[
  {
    "week_id": 44,
    "week_start": "2025-10-27",
    "week_end": "2025-11-02",
    "company_hours": 22.0,
    "sidejob_hours": 25.0,
    "total_hours": 47.0,
    "previous_month_hours": {
      "company": 14.0,
      "sidejob": 12.0,
      "dates": ["2025-10-27", "2025-10-28", "2025-10-29", "2025-10-30", "2025-10-31"]
    },
    "current_month_hours": {
      "company": 8.0,
      "sidejob": 13.0,
      "dates": ["2025-11-01", "2025-11-02"]
    },
    "violations": [
      {
        "type": "company_hours_exceeded",
        "limit": 20,
        "actual": 22.0,
        "message": "弊社での週20時間制限を超過"
      },
      {
        "type": "total_hours_exceeded",
        "limit": 40,
        "actual": 47.0,
        "message": "週40時間制限を超過（弊社+掛け持ち）"
      }
    ]
  }
]
```

## 🔧 技術仕様

### 1. フロントエンド（Vue.js）

#### 1.1 コンポーネント構成
```
ShiftRequestForm.vue (親)
├── WeekShiftInput.vue (週単位入力)
├── HourCalculator.js (時間計算ロジック)
└── ValidationChecker.js (制限チェック)
```

#### 1.2 データフロー
```javascript
// 親コンポーネントでの状態管理
const weeks = ref([
  {
    id: 1,
    title: '第1週 (9/28-10/4)',
    days: [...],
    shifts: {
      company: { start: {...}, end: {...} },
      sidejob: { start: {...}, end: {...} }
    }
  }
])

// リアルタイム計算（二重チェック対応）
const weeklyCalculations = computed(() => {
  return weeks.value.map(week => {
    const companyHours = calculateHours(week.shifts.company)
    const sidejobHours = calculateHours(week.shifts.sidejob)
    const totalHours = companyHours + sidejobHours

    return {
      companyHours,
      sidejobHours,
      totalHours,
      violations: {
        companyExceeded: companyHours > 20,
        totalExceeded: totalHours > 40,
        hasAnyViolation: companyHours > 20 || totalHours > 40
      },
      warningMessages: [
        ...(companyHours > 20 ? ['弊社20時間制限超過'] : []),
        ...(totalHours > 40 ? ['週40時間制限超過'] : [])
      ]
    }
  })
})
```

### 2. バックエンド（Rails）

#### 2.1 週中心モデル設計
```ruby
class Week < ApplicationRecord
  has_many :weekly_shifts, dependent: :destroy
  has_many :users, through: :weekly_shifts

  validates :start_date, :end_date, presence: true
  validates :start_date, uniqueness: true

  scope :for_month, ->(year, month) {
    month_start = Date.new(year, month, 1)
    month_end = month_start.end_of_month
    where('start_date <= ? AND end_date >= ?', month_end, month_start)
  }

  # 週番号計算
  def week_number
    start_date.cweek
  end

  # 月跨ぎ判定
  def cross_month?
    start_date.month != end_date.month
  end
end

class WeeklyShift < ApplicationRecord
  belongs_to :user
  belongs_to :week
  has_many :daily_schedules, dependent: :destroy

  enum status: { draft: 0, submitted: 1 }

  # 週間労働時間計算（月跨ぎ対応）
  def calculate_weekly_hours
    current_month_hours = calculate_current_month_hours
    previous_month_hours = fetch_previous_month_hours

    {
      company: current_month_hours[:company] + previous_month_hours[:company],
      sidejob: current_month_hours[:sidejob] + previous_month_hours[:sidejob],
      total: current_month_hours[:total] + previous_month_hours[:total],
      breakdown: {
        current_month: current_month_hours,
        previous_month: previous_month_hours
      }
    }
  end

  # 当月分時間計算
  def calculate_current_month_hours
    target_month_schedules = daily_schedules.where(
      date: Date.new(submission_year, submission_month, 1)..Date.new(submission_year, submission_month, 1).end_of_month
    )

    company_hours = target_month_schedules.sum(&:company_actual_hours)
    sidejob_hours = target_month_schedules.sum(&:sidejob_actual_hours)

    {
      company: company_hours,
      sidejob: sidejob_hours,
      total: company_hours + sidejob_hours
    }
  end

  # 前月確定データの取得
  def fetch_previous_month_hours
    return { company: 0, sidejob: 0, total: 0 } unless week.cross_month?

    previous_month_date = Date.new(submission_year, submission_month, 1) - 1.month
    previous_weekly_shift = user.weekly_shifts
                               .joins(:week)
                               .where(weeks: { start_date: week.start_date })
                               .where(submission_year: previous_month_date.year,
                                     submission_month: previous_month_date.month,
                                     status: [:confirmed, :approved])
                               .first

    return { company: 0, sidejob: 0, total: 0 } unless previous_weekly_shift

    # 前月に属する日付のみ集計
    month_end = Date.new(submission_year, submission_month, 1) - 1.day
    target_dates = (week.start_date..week.end_date).select { |d| d <= month_end }

    previous_schedules = previous_weekly_shift.daily_schedules.where(date: target_dates)
    company_hours = previous_schedules.sum(&:company_actual_hours)
    sidejob_hours = previous_schedules.sum(&:sidejob_actual_hours)

    {
      company: company_hours,
      sidejob: sidejob_hours,
      total: company_hours + sidejob_hours
    }
  end

  # 制限違反チェック（二重チェック）
  def check_violations
    weekly_hours = calculate_weekly_hours
    violations = []

    # 弊社20時間制限チェック
    if weekly_hours[:company] > 20
      violations << {
        type: 'company_hours_exceeded',
        limit: 20,
        actual: weekly_hours[:company],
        message: '弊社での週20時間制限を超過'
      }
    end

    # 合計40時間制限チェック
    if weekly_hours[:total] > 40
      violations << {
        type: 'total_hours_exceeded',
        limit: 40,
        actual: weekly_hours[:total],
        message: '週40時間制限を超過（弊社+掛け持ち）'
      }
    end

    if violations.any?
      self.violation_warnings = [{
        week_id: week.id,
        week_start: week.start_date,
        week_end: week.end_date,
        company_hours: weekly_hours[:company],
        sidejob_hours: weekly_hours[:sidejob],
        total_hours: weekly_hours[:total],
        previous_month_hours: weekly_hours[:breakdown][:previous_month],
        current_month_hours: weekly_hours[:breakdown][:current_month],
        violations: violations
      }].to_json
    else
      self.violation_warnings = nil
    end
  end
end

class DailySchedule < ApplicationRecord
  belongs_to :weekly_shift

  validates :date, presence: true
  validates :date, uniqueness: { scope: :weekly_shift_id }

  # 弊社実労働時間計算
  def company_actual_hours
    return 0 unless is_company_working && company_start_time && company_end_time

    total_minutes = time_diff_in_minutes(company_start_time, company_end_time)
    break_minutes = total_minutes >= 360 ? 60 : 0  # 6時間以上なら1時間休憩

    (total_minutes - break_minutes) / 60.0
  end

  # 掛け持ち実労働時間計算
  def sidejob_actual_hours
    return 0 unless is_sidejob_working && sidejob_start_time && sidejob_end_time

    total_minutes = time_diff_in_minutes(sidejob_start_time, sidejob_end_time)
    break_minutes = total_minutes >= 360 ? 60 : 0

    (total_minutes - break_minutes) / 60.0
  end

  private

  # HH:MM形式の文字列から時間差を分単位で計算
  def time_diff_in_minutes(start_str, end_str)
    start_parts = start_str.split(':').map(&:to_i)
    end_parts = end_str.split(':').map(&:to_i)

    start_minutes = start_parts[0] * 60 + start_parts[1]
    end_minutes = end_parts[0] * 60 + end_parts[1]

    end_minutes - start_minutes
  end
end

class MonthlySummary < ApplicationRecord
  belongs_to :user

  enum status: { draft: 0, submitted: 1 }

  validates :year, :month, presence: true
  validates :month, uniqueness: { scope: [:user_id, :year] }

  # 月次集計の更新
  def update_summary
    weekly_shifts = user.weekly_shifts
                       .where(submission_year: year, submission_month: month)

    self.total_company_hours = weekly_shifts.sum { |ws| ws.calculate_current_month_hours[:company] }
    self.total_sidejob_hours = weekly_shifts.sum { |ws| ws.calculate_current_month_hours[:sidejob] }
    self.total_all_hours = total_company_hours + total_sidejob_hours
    save!
  end
end
```

#### 2.2 週中心 API エンドポイント
```ruby
# routes.rb
resources :monthly_summaries, only: [:index, :show] do
  member do
    patch :submit
  end
end

resources :weekly_shifts, only: [:show, :edit, :update] do
  member do
    patch :save_draft
    patch :submit_shift
    patch :back_to_draft  # 再編集のため
  end
  resources :daily_schedules, only: [:update]
end

# 月指定でのシフト表示・作成
get 'shifts/:year/:month', to: 'monthly_summaries#show_month', as: :shift_month
get 'shifts/:year/:month/new', to: 'monthly_summaries#new_month', as: :new_shift_month

# monthly_summaries_controller.rb
class MonthlySummariesController < ApplicationController
  def show_month
    @year, @month = params[:year].to_i, params[:month].to_i
    @summary = current_user.monthly_summaries
                          .find_or_create_by(year: @year, month: @month)

    @weeks = Week.for_month(@year, @month)
    @weekly_shifts = load_weekly_shifts_for_month(@year, @month)

    render json: {
      summary: @summary,
      weeks: @weeks,
      weekly_shifts: @weekly_shifts.map(&:as_json_with_schedules),
      editable: editable_month?(@year, @month)
    }
  end

  def submit
    @summary = current_user.monthly_summaries.find(params[:id])

    # 全週の制限チェック
    weekly_shifts = current_user.weekly_shifts
                               .where(submission_year: @summary.year,
                                     submission_month: @summary.month)

    violations = []
    weekly_shifts.each do |ws|
      ws.check_violations
      if ws.violation_warnings.present?
        violations.concat(JSON.parse(ws.violation_warnings))
      end
    end

    if violations.any?
      render json: {
        status: 'violations_found',
        violations: violations
      }
    else
      @summary.update!(status: :submitted)
      weekly_shifts.update_all(status: :submitted, submitted_at: Time.current)
      render json: { status: 'submitted' }
    end
  end

  private

  def load_weekly_shifts_for_month(year, month)
    weeks = Week.for_month(year, month)
    current_user.weekly_shifts
               .includes(:daily_schedules)
               .where(week: weeks, submission_year: year, submission_month: month)
               .or(
                 current_user.weekly_shifts
                            .includes(:daily_schedules)
                            .where(week: weeks)
                            .where(submission_year: year - (month == 1 ? 1 : 0),
                                  submission_month: month == 1 ? 12 : month - 1,
                                  status: [:confirmed, :approved])
               )
  end

  def editable_month?(year, month)
    target_date = Date.new(year, month, 1)
    target_date > Date.current.beginning_of_month
  end
end

# weekly_shifts_controller.rb
class WeeklyShiftsController < ApplicationController
  def update
    @weekly_shift = current_user.weekly_shifts.find(params[:id])

    if @weekly_shift.update(weekly_shift_params)
      @weekly_shift.check_violations
      render json: {
        status: 'success',
        weekly_shift: @weekly_shift.as_json_with_schedules,
        violations: @weekly_shift.violation_warnings
      }
    else
      render json: { status: 'error', errors: @weekly_shift.errors }
    end
  end

  def save_draft
    @weekly_shift = current_user.weekly_shifts.find(params[:id])
    @weekly_shift.update!(status: :draft)
    render json: { status: 'draft_saved' }
  end

  def submit_shift
    @weekly_shift = current_user.weekly_shifts.find(params[:id])
    @weekly_shift.check_violations

    if @weekly_shift.violation_warnings.present?
      render json: {
        status: 'violations_found',
        violations: JSON.parse(@weekly_shift.violation_warnings)
      }
    else
      @weekly_shift.update!(status: :submitted, submitted_at: Time.current)
      render json: { status: 'submitted' }
    end
  end
end
```

## 📊 ビジネスルール

### 1. 労働時間制限
- **週20時間制限**: 弊社での実労働時間（休憩除く）※学生バイト法的制限
- **週40時間制限**: 弊社 + 掛け持ちの合計実労働時間 ※労働基準法制限
- **二重チェック**: 両制限を独立して検証し、どちらか一方でも超過なら警告
- **休憩時間**: 6時間以上勤務の場合、1時間の休憩を自動差し引き

### 2. 週の定義
- **週の開始**: 月曜日開始（月〜日の7日間）
- **月跨ぎ**: 前月確定データ + 当月入力データで週制限チェック
- **計算範囲**: 週に含まれる全日程（月跨ぎ含む）

### 3. 提出・再編集フロー
```
draft → submitted
  ↑        ↓
  └── 再編集可能（学業優先のため制限内であれば何度でも変更可）
```

**承認不要の理由**:
- 週20時間/40時間制限は全てバリデーションで保証済み
- シフト希望は学生の「希望」であり、確定ではない
- 学業を優先してシフトを減らすことを推奨
- 実際の勤務は勤怠登録で別途管理・承認される

## ✅ 受け入れ条件

### 機能面
- [ ] 月間5週分のシフト入力が可能
- [ ] 弊社・掛け持ちの時間を個別入力可能
- [ ] リアルタイムで週間労働時間を計算・表示
- [ ] 制限超過時の視覚的警告表示
- [ ] 制限超過時の提出ブロック
- [ ] 下書き保存・復元機能
- [ ] 提出後も再編集可能な制御

### 技術面
- [ ] Vue.js でのリアクティブな UI
- [ ] Rails API での制限チェック
- [ ] PostgreSQL での効率的なデータ保存
- [ ] 既存テーブル構造の有効活用

### UX面
- [ ] 直感的な時間入力（HTML5 time input）
- [ ] 週単位での制限状況の可視化
- [ ] エラー状態の分かりやすい表示
- [ ] 提出前の確認ダイアログ

## 📋 実装優先度

### Phase 1: 基本機能
1. Vue.js でのシフト入力 UI
2. リアルタイム時間計算
3. 基本的な制限チェック

### Phase 2: データ永続化
1. Rails API での保存機能
2. 下書き保存・復元
3. 提出状態管理

### Phase 3: 高度な機能
1. 詳細なバリデーション
2. 一括入力機能
3. ~~承認フロー連携~~（不要 - シフト希望は承認対象外）

## 📚 参考資料

- [ユーザーストーリー](./ユーザーストーリー.md)
- [デザインファイル](../design/03-shift-request-simple.html)
- [ER図](../design/er_diagram.html)

## 🆕 週中心設計による高度な機能

### 1. シンプルな状態管理システム

#### 1.1 ステータス管理
- **draft**: 下書き状態（編集中）
- **submitted**: 提出済み状態（制限内であれば何度でも再編集可能）

#### 1.2 再編集の自由度
```ruby
# 学業優先のため、提出後も制限内であれば自由に編集可能
class WeeklyShift
  # 提出済みでも下書きに戻せる
  def back_to_draft
    update!(status: :draft)
  end

  # 再提出
  def resubmit
    update!(status: :submitted, submitted_at: Time.current)
  end
end
```

### 2. 月管理機能の強化

#### 2.1 基本ルール
- **対象月**: ダッシュボードからは「今月」のシフト作成・編集
- **月移動**: シフト画面で前後月への移動ボタン
- **編集制限**:
  - 過去月: 編集不可（確定済み）
  - 当月・来月以降: 編集・保存可能（学業優先のため柔軟に変更可能）

#### 2.2 表示制御
```ruby
# コントローラーでの制御例
def editable?
  target_date = Date.new(year, month, 1)
  target_date >= Date.current.beginning_of_month
end
```

### 2. 週中心設計による月跨ぎ対応

#### 2.1 週の定義と管理
- **週単位**: 月曜日〜日曜日（ISO 8601準拠）
- **週テーブル**: 全ての週を事前に`Week`テーブルで管理
- **月跨ぎ処理**: 週単位で自然に月境界を扱う

#### 2.2 月跨ぎ週のデータ設計
```ruby
# 例: 2025年11月のシフト作成時（第44週: 10/27-11/2）
#
# Week テーブル:
# id: 44, start_date: '2025-10-27', end_date: '2025-11-02', is_cross_month: true
#
# WeeklyShift テーブル:
# 10月提出分: week_id: 44, submission_year: 2025, submission_month: 10, status: 'approved'
# 11月提出分: week_id: 44, submission_year: 2025, submission_month: 11, status: 'draft'
#
# DailySchedule テーブル:
# 10月分: dates: ['2025-10-27', '2025-10-28', '2025-10-29', '2025-10-30', '2025-10-31']
# 11月分: dates: ['2025-11-01', '2025-11-02']
```

#### 2.3 制限チェックの統合
```ruby
# 11月シフト入力時の週40時間制限チェック
def calculate_week_44_hours
  # 10月確定分
  oct_weekly_shift = user.weekly_shifts
                        .where(week_id: 44, submission_month: 10,
                               status: [:confirmed, :approved])
                        .first
  oct_hours = oct_weekly_shift&.calculate_current_month_hours || {company: 0, sidejob: 0}

  # 11月入力分
  nov_weekly_shift = user.weekly_shifts
                        .where(week_id: 44, submission_month: 11)
                        .first
  nov_hours = nov_weekly_shift&.calculate_current_month_hours || {company: 0, sidejob: 0}

  # 週合計
  {
    company: oct_hours[:company] + nov_hours[:company],
    sidejob: oct_hours[:sidejob] + nov_hours[:sidejob],
    total: (oct_hours[:company] + oct_hours[:sidejob]) +
           (nov_hours[:company] + nov_hours[:sidejob])
  }
end
```

#### 2.4 UI表示での前月データ継承
- **前月データ**: `status: [:confirmed, :approved]` の WeeklyShift を参照
- **表示形式**: グレーアウト + 編集不可マーカー
- **計算対象**: 週制限チェックには含める
- **データ更新**: 前月データは変更不可、当月データのみ編集可能

### 3. 土日勤務制限

#### 3.1 基本制約
- **平日のみ**: 月〜金曜日の入力を許可
- **土日制限**: 入力フィールド無効化
- **例外処理**: 管理者権限での特別対応（将来拡張）

#### 3.2 UI制御
```javascript
// Vue.js での制御
const isWeekend = (date) => {
  const dayOfWeek = date.getDay()
  return dayOfWeek === 0 || dayOfWeek === 6  // 日曜=0, 土曜=6
}

const isEditable = (date) => {
  return !isWeekend(date) && isInEditableMonth(date)
}
```

---

## 🚨 実装時の正しい認識（重要）

### 実際の仕様と認識違い

#### ❌ 間違った認識（Claude実装時）
- 新しい `/monthly_summaries` システム全体を作成
- 大量の新規テーブル、コントローラー、ビューを追加
- 既存のフローを無視した独自システム

#### ✅ 正しい認識
- **既存のページ**: `http://localhost:3000/shift_requests/new`
- **既存のコントローラー**: `ShiftRequestsController`
- **既存のビュー**: `app/views/shift_requests/new.html.erb`
- **実装対象**: この既存ページのVue.jsコンポーネント改善のみ

### 正しい実装範囲

#### 修正対象ファイル（のみ）
```
app/views/shift_requests/new.html.erb    # 既存ビューの修正
frontend/components/ShiftRequestForm.vue # Vue.jsコンポーネント改善
frontend/components/WeekShiftInput.vue   # 週単位入力コンポーネント
app/controllers/shift_requests_controller.rb # 必要最小限の修正
```

#### 新規作成不要なファイル
```
❌ app/controllers/monthly_summaries_controller.rb
❌ app/models/monthly_summary.rb
❌ app/models/weekly_shift.rb
❌ app/models/week.rb
❌ app/models/daily_schedule.rb
❌ db/migrate/20251005* (全ての新規マイグレーション)
❌ app/views/monthly_summaries/**/*
❌ app/views/weekly_shifts/**/*
❌ lib/tasks/weeks.rake
❌ lib/tasks/migration_support.rake
❌ その他の週中心設計ファイル群
```

### 正しいフロー
1. ダッシュボードの「シフト希望提出」ボタンクリック
2. `http://localhost:3000/shift_requests/new` に遷移
3. 既存の Vue.js コンポーネントが改善された UI を表示
4. リアルタイム時間計算・制限チェック機能
5. 既存のデータベース構造を使用した保存

### 週中心設計について
- **仕様書での議論**: 将来的な改善案として有効
- **現在の実装**: 既存システムの改善にとどめる
- **段階的移行**: 将来のフェーズで検討

### 緊急対応
現在大量の不要ファイルが作成されている状態のため、以下を実施：
1. 不要ファイルの削除
2. 既存ファイルの変更を元に戻す
3. 本来の `shift_requests/new` ページ改善に集中

---

## 🔌 API設計 (モックからAPI化)

### 1. API概要

現在のVue.jsコンポーネントは静的なモックデータを使用しているが、実際のデータベースとの連携のためAPI化を行う。

### 2. API仕様

#### 2.1 週データ取得API

**エンドポイント**: `GET /api/shift_requests/weeks`

**パラメータ**:
```json
{
  "year": 2025,
  "month": 10
}
```

**レスポンス**:
```json
{
  "status": "success",
  "data": {
    "weeks": [
      {
        "id": 1,
        "title": "第1週 (9/28-10/4)",
        "start_date": "2025-09-28",
        "end_date": "2025-10-04",
        "is_cross_month": true,
        "days_in_month": 4,
        "days": [
          {
            "key": "mon",
            "label": "月 9/30",
            "date": "2025-09-30",
            "in_target_month": false
          },
          {
            "key": "tue",
            "label": "火 10/1",
            "date": "2025-10-01",
            "in_target_month": true
          }
        ]
      }
    ],
    "target_year": 2025,
    "target_month": 10,
    "editable": true
  }
}
```

#### 2.2 既存シフトデータ取得API

**エンドポイント**: `GET /api/shift_requests/existing`

**パラメータ**:
```json
{
  "year": 2025,
  "month": 10
}
```

**レスポンス**:
```json
{
  "status": "success",
  "data": {
    "shifts": {
      "week_1": {
        "company": {
          "start": {
            "mon": "",
            "tue": "",
            "wed": "",
            "thu": "",
            "fri": "09:00",
            "sat": "",
            "sun": ""
          },
          "end": {
            "mon": "",
            "tue": "",
            "wed": "",
            "thu": "",
            "fri": "16:00",
            "sat": "",
            "sun": ""
          }
        },
        "sidejob": {
          "start": {
            "tue": "18:00",
            "thu": "18:00"
          },
          "end": {
            "tue": "22:00",
            "thu": "22:00"
          }
        }
      }
    },
    "status": "draft",
    "last_saved": "2025-10-05T12:30:00Z"
  }
}
```

#### 2.3 シフト保存API（下書き）

**エンドポイント**: `POST /api/shift_requests/save_draft`

**リクエストボディ**:
```json
{
  "year": 2025,
  "month": 10,
  "shifts": {
    "week_1": {
      "company": {
        "start": {
          "mon": "09:00",
          "tue": "",
          "wed": "09:00",
          "thu": "",
          "fri": "09:00",
          "sat": "",
          "sun": ""
        },
        "end": {
          "mon": "16:00",
          "tue": "",
          "wed": "16:00",
          "thu": "",
          "fri": "16:00",
          "sat": "",
          "sun": ""
        }
      },
      "sidejob": {
        "start": {
          "tue": "18:00",
          "thu": "18:00"
        },
        "end": {
          "tue": "22:00",
          "thu": "22:00"
        }
      }
    }
  }
}
```

**レスポンス**:
```json
{
  "status": "success",
  "message": "下書きを保存しました",
  "data": {
    "saved_at": "2025-10-05T12:35:00Z",
    "validation_results": [
      {
        "week_id": 1,
        "week_title": "第1週 (9/28-10/4)",
        "company_hours": 21.0,
        "sidejob_hours": 8.0,
        "total_hours": 29.0,
        "violations": [
          {
            "type": "company_hours_exceeded",
            "limit": 20,
            "actual": 21.0,
            "message": "弊社での週20時間制限を超過"
          }
        ]
      }
    ]
  }
}
```

#### 2.4 シフト提出API

**エンドポイント**: `POST /api/shift_requests/submit`

**リクエストボディ**:
```json
{
  "year": 2025,
  "month": 10,
  "shifts": {
    // 2.3と同じ形式
  }
}
```

**レスポンス（成功時）**:
```json
{
  "status": "success",
  "message": "シフトを提出しました",
  "data": {
    "submitted_at": "2025-10-05T12:40:00Z",
    "submission_id": "shift_2025_10_user_123"
  }
}
```

**レスポンス（制限違反時）**:
```json
{
  "status": "violation_error",
  "message": "労働時間制限に違反があります",
  "errors": [
    {
      "week_id": 1,
      "week_title": "第1週 (9/28-10/4)",
      "violations": [
        {
          "type": "company_hours_exceeded",
          "limit": 20,
          "actual": 22.0,
          "message": "弊社での週20時間制限を超過"
        },
        {
          "type": "total_hours_exceeded",
          "limit": 40,
          "actual": 45.0,
          "message": "週40時間制限を超過（弊社+掛け持ち）"
        }
      ]
    }
  ]
}
```

#### 2.5 リアルタイム検証API

**エンドポイント**: `POST /api/shift_requests/validate`

**リクエストボディ**:
```json
{
  "week_shifts": {
    "week_1": {
      "company": {
        "start": {"mon": "09:00", "fri": "09:00"},
        "end": {"mon": "16:00", "fri": "16:00"}
      },
      "sidejob": {
        "start": {"tue": "18:00"},
        "end": {"tue": "22:00"}
      }
    }
  }
}
```

**レスポンス**:
```json
{
  "status": "success",
  "data": {
    "validations": [
      {
        "week_id": 1,
        "company_hours": 14.0,
        "sidejob_hours": 4.0,
        "total_hours": 18.0,
        "company_violation": false,
        "total_violation": false,
        "messages": []
      }
    ],
    "overall_valid": true
  }
}
```

### 3. コントローラー実装

#### 3.1 API専用コントローラー作成

```ruby
# app/controllers/api/shift_requests_controller.rb
class Api::ShiftRequestsController < ApplicationController
  before_action :authenticate_user!

  def weeks
    year = params[:year].to_i
    month = params[:month].to_i

    weeks_data = generate_weeks_for_month(year, month)

    render json: {
      status: 'success',
      data: {
        weeks: weeks_data,
        target_year: year,
        target_month: month,
        editable: editable_month?(year, month)
      }
    }
  end

  def existing
    year = params[:year].to_i
    month = params[:month].to_i

    # 既存のシフトデータを取得
    existing_shifts = load_existing_shifts(year, month)

    render json: {
      status: 'success',
      data: {
        shifts: existing_shifts,
        status: 'draft', # TODO: 実際のステータス
        last_saved: Time.current.iso8601
      }
    }
  end

  def save_draft
    year = params[:year].to_i
    month = params[:month].to_i
    shifts_data = params[:shifts]

    # 下書き保存処理
    result = save_shifts_as_draft(year, month, shifts_data)
    validation_results = validate_shifts(shifts_data)

    render json: {
      status: 'success',
      message: '下書きを保存しました',
      data: {
        saved_at: Time.current.iso8601,
        validation_results: validation_results
      }
    }
  end

  def submit
    year = params[:year].to_i
    month = params[:month].to_i
    shifts_data = params[:shifts]

    # 最終検証
    validation_results = validate_shifts(shifts_data)
    violations = validation_results.select { |r| r[:violations].any? }

    if violations.any?
      render json: {
        status: 'violation_error',
        message: '労働時間制限に違反があります',
        errors: violations
      }
    else
      # 提出処理
      submit_shifts(year, month, shifts_data)

      render json: {
        status: 'success',
        message: 'シフトを提出しました',
        data: {
          submitted_at: Time.current.iso8601,
          submission_id: "shift_#{year}_#{month}_user_#{current_user.id}"
        }
      }
    end
  end

  def validate
    shifts_data = params[:week_shifts]
    validation_results = validate_shifts(shifts_data)

    render json: {
      status: 'success',
      data: {
        validations: validation_results,
        overall_valid: validation_results.all? { |r| r[:violations].empty? }
      }
    }
  end

  private

  def generate_weeks_for_month(year, month)
    # 月の週データを生成
    # TODO: 実装詳細
    [
      {
        id: 1,
        title: "第1週 (9/28-10/4)",
        start_date: "2025-09-28",
        end_date: "2025-10-04",
        is_cross_month: true,
        days_in_month: 4,
        days: [
          {
            key: "mon",
            label: "月 9/30",
            date: "2025-09-30",
            in_target_month: false
          },
          {
            key: "tue",
            label: "火 10/1",
            date: "2025-10-01",
            in_target_month: true
          }
          # ... 他の日
        ]
      }
      # ... 他の週
    ]
  end

  def load_existing_shifts(year, month)
    # 既存のシフトデータを取得
    # TODO: 実装詳細
    {}
  end

  def save_shifts_as_draft(year, month, shifts_data)
    # 下書き保存処理
    # TODO: 実装詳細
  end

  def submit_shifts(year, month, shifts_data)
    # 最終提出処理
    # TODO: 実装詳細
  end

  def validate_shifts(shifts_data)
    # 労働時間制限検証
    results = []

    shifts_data.each do |week_key, week_data|
      week_id = week_key.gsub('week_', '').to_i

      company_hours = calculate_weekly_hours(week_data['company'])
      sidejob_hours = calculate_weekly_hours(week_data['sidejob'])
      total_hours = company_hours + sidejob_hours

      violations = []
      violations << {
        type: 'company_hours_exceeded',
        limit: 20,
        actual: company_hours,
        message: '弊社での週20時間制限を超過'
      } if company_hours > 20

      violations << {
        type: 'total_hours_exceeded',
        limit: 40,
        actual: total_hours,
        message: '週40時間制限を超過（弊社+掛け持ち）'
      } if total_hours > 40

      results << {
        week_id: week_id,
        week_title: "第#{week_id}週", # TODO: 実際のタイトル
        company_hours: company_hours,
        sidejob_hours: sidejob_hours,
        total_hours: total_hours,
        violations: violations
      }
    end

    results
  end

  def calculate_weekly_hours(shift_times)
    return 0 unless shift_times

    total_hours = 0
    %w[mon tue wed thu fri sat sun].each do |day|
      start_time = shift_times['start']&.[](day)
      end_time = shift_times['end']&.[](day)

      next unless start_time.present? && end_time.present?

      start_minutes = time_to_minutes(start_time)
      end_minutes = time_to_minutes(end_time)

      working_minutes = end_minutes - start_minutes
      working_minutes -= 60 if working_minutes >= 360 # 6時間以上は1時間休憩

      total_hours += working_minutes / 60.0
    end

    total_hours.round(1)
  end

  def time_to_minutes(time_str)
    hour, minute = time_str.split(':').map(&:to_i)
    hour * 60 + minute
  end

  def editable_month?(year, month)
    target_date = Date.new(year, month, 1)
    target_date > Date.current.beginning_of_month
  end
end
```

#### 3.2 ルーティング追加

```ruby
# config/routes.rb に追加
namespace :api do
  resources :shift_requests, only: [] do
    collection do
      get :weeks
      get :existing
      post :save_draft
      post :submit
      post :validate
    end
  end
end
```

### 4. Vue.jsコンポーネント API連携

#### 4.1 API呼び出し関数

```javascript
// frontend/services/ShiftRequestAPI.js
export class ShiftRequestAPI {
  static async getWeeks(year, month) {
    const response = await fetch(`/api/shift_requests/weeks?year=${year}&month=${month}`)
    return response.json()
  }

  static async getExistingShifts(year, month) {
    const response = await fetch(`/api/shift_requests/existing?year=${year}&month=${month}`)
    return response.json()
  }

  static async saveDraft(year, month, shifts) {
    const response = await fetch('/api/shift_requests/save_draft', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ year, month, shifts })
    })
    return response.json()
  }

  static async submitShifts(year, month, shifts) {
    const response = await fetch('/api/shift_requests/submit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ year, month, shifts })
    })
    return response.json()
  }

  static async validateShifts(weekShifts) {
    const response = await fetch('/api/shift_requests/validate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ week_shifts: weekShifts })
    })
    return response.json()
  }
}
```

#### 4.2 コンポーネント修正案

```javascript
// frontend/components/ShiftRequestForm.vue内のsetup()関数
export default {
  setup(props) {
    const weeks = ref([])
    const isLoading = ref(true)
    const errorMessage = ref('')

    // APIからデータ取得
    const loadWeeksData = async () => {
      try {
        isLoading.value = true

        // 週データとexistingShiftsを並行取得
        const [weeksResponse, existingResponse] = await Promise.all([
          ShiftRequestAPI.getWeeks(props.targetYear, props.targetMonth),
          ShiftRequestAPI.getExistingShifts(props.targetYear, props.targetMonth)
        ])

        if (weeksResponse.status === 'success') {
          weeks.value = weeksResponse.data.weeks.map(week => ({
            ...week,
            shifts: existingResponse.data.shifts[`week_${week.id}`] || createEmptyShifts()
          }))
        }
      } catch (error) {
        console.error('Failed to load shift data:', error)
        errorMessage.value = 'データの読み込みに失敗しました'
      } finally {
        isLoading.value = false
      }
    }

    // 下書き保存
    const saveShifts = async () => {
      try {
        const shiftsData = convertWeeksToAPIFormat(weeks.value)
        const response = await ShiftRequestAPI.saveDraft(
          props.targetYear,
          props.targetMonth,
          shiftsData
        )

        if (response.status === 'success') {
          alert('下書きを保存しました')
          // 検証結果があれば表示
          if (response.data.validation_results?.length > 0) {
            displayValidationResults(response.data.validation_results)
          }
        }
      } catch (error) {
        console.error('Save failed:', error)
        alert('保存に失敗しました')
      }
    }

    // 最終提出
    const submitShifts = async () => {
      try {
        const shiftsData = convertWeeksToAPIFormat(weeks.value)
        const response = await ShiftRequestAPI.submitShifts(
          props.targetYear,
          props.targetMonth,
          shiftsData
        )

        if (response.status === 'success') {
          alert('シフトを提出しました')
          // 提出後はページ遷移等
          window.location.href = '/shift_requests'
        } else if (response.status === 'violation_error') {
          errorMessage.value = response.message
          displayViolationErrors(response.errors)
        }
      } catch (error) {
        console.error('Submit failed:', error)
        alert('提出に失敗しました')
      }
    }

    onMounted(() => {
      loadWeeksData()
    })

    return {
      weeks,
      isLoading,
      errorMessage,
      saveShifts,
      submitShifts
      // ...
    }
  }
}
```

### 5. 実装手順

1. **APIコントローラー作成**
   - `Api::ShiftRequestsController` の作成
   - 基本的なエンドポイント実装

2. **Vue.js API連携**
   - API呼び出しサービスクラス作成
   - コンポーネントのモックデータをAPI呼び出しに変更

3. **データ永続化**
   - 既存データベース構造でのシフトデータ保存
   - 下書き・提出状態管理

4. **エラーハンドリング**
   - API通信エラー対応
   - 制限違反エラー表示

5. **テスト・検証**
   - API動作確認
   - Vue.js連携テスト
   - 制限チェック検証
