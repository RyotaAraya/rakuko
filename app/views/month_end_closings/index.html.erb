<% content_for :title, "æœˆæœ«ç· ã‚å‡¦ç† - å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ " %>

<%= render 'shared/header' %>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
  }
  .section-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .section-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 16px;
    color: #1a1a1a;
  }
  .checklist-item {
    display: flex;
    align-items: flex-start;
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
  }
  .checklist-item:last-child {
    border-bottom: none;
  }
  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  .status-open { background: #e3f2fd; color: #1976d2; }
  .status-pending_approval { background: #fff3e0; color: #f57c00; }
  .status-closed { background: #e8f5e9; color: #2e7d32; }
  .status-locked { background: #f3e5f5; color: #7b1fa2; }
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
  }
  .btn-primary {
    background: #1976d2;
    color: white;
  }
  .btn-primary:hover {
    background: #1565c0;
  }
  .btn-secondary {
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
  }
  .btn-secondary:hover {
    background: #e8e8e8;
  }
  .btn-success {
    background: #2e7d32;
    color: white;
  }
  .btn-success:hover {
    background: #1b5e20;
  }
  .btn-warning {
    background: #f57c00;
    color: white;
  }
  .btn-warning:hover {
    background: #e65100;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-item {
    text-align: center;
  }
  .stat-label {
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #1a1a1a;
  }
  .external-link {
    color: #1976d2;
    text-decoration: none;
    font-weight: 500;
  }
  .external-link:hover {
    text-decoration: underline;
  }
</style>

<div class="container">
  <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 24px;">æœˆæœ«ç· ã‚å‡¦ç†</h1>

  <% if current_user.student? %>
    <!-- æœˆé¸æŠUI -->
    <div class="section-card" style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <label style="font-weight: bold; font-size: 14px;">å¯¾è±¡æœˆ:</label>
        <select id="month-selector" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
          <% @available_months.each do |month_data| %>
            <% selected = (month_data[:year] == @year && month_data[:month] == @month) %>
            <option value="<%= month_data[:year] %>-<%= month_data[:month] %>" <%= 'selected' if selected %>>
              <%= month_data[:year] %>å¹´<%= month_data[:month] %>æœˆ
            </option>
          <% end %>
        </select>
      </div>
    </div>

    <!-- å­¦ç”Ÿç”¨ï¼šè‡ªåˆ†ã®ç· ã‚å‡¦ç† + ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
    <div class="section-card">
      <div class="section-title"><%= @year %>å¹´<%= @month %>æœˆã®ç· ã‚å‡¦ç†</div>

      <% if @current_closing.persisted? %>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">ç·åŠ´åƒæ™‚é–“</div>
            <div class="stat-value"><%= @current_closing.total_work_hours %><span style="font-size: 16px; font-weight: normal;">h</span></div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å‡ºå‹¤æ—¥æ•°</div>
            <div class="stat-value"><%= @current_closing.total_work_days %><span style="font-size: 16px; font-weight: normal;">æ—¥</span></div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
            <div style="margin-top: 12px;">
              <span class="status-badge status-<%= @current_closing.status %>">
                <%= @current_closing.status_display_name %>
              </span>
            </div>
          </div>
        </div>

        <% if @current_closing.can_submit_for_approval? %>
          <div style="margin-top: 20px;">
            <%= button_to "æ‰¿èªç”³è«‹ã‚’æå‡º", submit_for_approval_month_end_closing_path(@current_closing),
                          method: :post,
                          form: { data: { turbo_confirm: "#{@year}å¹´#{@month}æœˆã®æœˆæœ«ç· ã‚ã‚’æ‰¿èªç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ\néƒ¨ç½²æ‹…å½“è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚" }, id: "submit-approval-form" },
                          class: "btn btn-success",
                          id: "submit-approval-btn",
                          style: "pointer-events: none; opacity: 0.5;" %>
            <div style="margin-top: 8px; font-size: 13px; color: #e65100;" id="checklist-warning">
              âš ï¸ ãƒ©ã‚¯ãƒ­ãƒ¼ã¨ã‚¸ãƒ§ãƒ–ã‚«ãƒ³ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„
            </div>
          </div>
        <% elsif @current_closing.pending_approval? %>
          <div style="margin-top: 20px; padding: 12px; background: #e3f2fd; border: 1px solid #64b5f6; border-radius: 4px; color: #1976d2;">
            â„¹ï¸ æ‰¿èªç”³è«‹æ¸ˆã¿ã§ã™ã€‚éƒ¨ç½²æ‹…å½“è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
          </div>
        <% elsif @current_closing.pending_attendances_count > 0 %>
          <div style="margin-top: 20px; padding: 12px; background: #fff3e0; border: 1px solid #ffb74d; border-radius: 4px; color: #e65100;">
            âš ï¸ æ‰¿èªå¾…ã¡ã®å‹¤æ€ ãŒ <%= @current_closing.pending_attendances_count %> ä»¶ã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦æ‰¿èªã•ã‚Œã¦ã‹ã‚‰æ‰¿èªç”³è«‹ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚
          </div>
        <% end %>

        <% if @current_closing.closed_or_locked? && @current_closing.closed_at %>
          <div style="margin-top: 20px; font-size: 14px; color: #666;">
            ç· ã‚å®Ÿè¡Œæ—¥æ™‚: <%= @current_closing.closed_at.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') %>
            <% if @current_closing.closed_by %>
              ï¼ˆå®Ÿè¡Œè€…: <%= @current_closing.closed_by.display_name %>ï¼‰
            <% end %>
          </div>
        <% end %>
      <% else %>
        <p style="color: #666;">ã“ã®æœˆã®ç· ã‚å‡¦ç†ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      <% end %>
    </div>

    <!-- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
    <%if @current_closing.can_submit_for_approval?  %>
      <div class="section-card">
        <div class="section-title">å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>

        <div class="checklist-item">
          <input type="checkbox" id="rakuro_check" class="checklist-checkbox"
                style="margin-top: 4px; margin-right: 12px;">
          <label for="rakuro_check" style="flex: 1;">
            <div style="font-weight: 500; margin-bottom: 4px;">ğŸ“Š ãƒ©ã‚¯ãƒ­ãƒ¼ï¼ˆçµ¦ä¸è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã®ç¢ºèªå®Œäº†</div>
            <div style="font-size: 13px; color: #666;">
              <%= link_to "ãƒ©ã‚¯ãƒ­ãƒ¼ã‚’é–‹ã", "https://rakuro.example.com",
                          target: "_blank", class: "external-link" %>
              ã§å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ãƒ»çµ¦ä¸è¨ˆç®—ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            </div>
          </label>
        </div>

        <div class="checklist-item">
          <input type="checkbox" id="jobcan_check" class="checklist-checkbox"
                style="margin-top: 4px; margin-right: 12px;">
          <label for="jobcan_check" style="flex: 1;">
            <div style="font-weight: 500; margin-bottom: 4px;">ğŸš— ã‚¸ãƒ§ãƒ–ã‚«ãƒ³ï¼ˆäº¤é€šè²»ç²¾ç®—ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã®ç¢ºèªå®Œäº†</div>
            <div style="font-size: 13px; color: #666;">
              <%= link_to "ã‚¸ãƒ§ãƒ–ã‚«ãƒ³ã‚’é–‹ã", "https://jobcan.example.com",
                          target: "_blank", class: "external-link" %>
              ã§äº¤é€šè²»ç”³è«‹ãƒ»æ‰¿èªãƒ«ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„
            </div>
          </label>
        </div>
      </div>
    <% end %>

    <!-- ç· ã‚å±¥æ­´ -->
    <div class="section-card">
      <div class="section-title">ç· ã‚å±¥æ­´ï¼ˆç›´è¿‘12ãƒ¶æœˆï¼‰</div>

      <% if @closings.any? %>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #e0e0e0;">
              <th style="padding: 12px; text-align: left; font-size: 13px; color: #666;">å¯¾è±¡æœˆ</th>
              <th style="padding: 12px; text-align: right; font-size: 13px; color: #666;">åŠ´åƒæ™‚é–“</th>
              <th style="padding: 12px; text-align: right; font-size: 13px; color: #666;">å‡ºå‹¤æ—¥æ•°</th>
              <th style="padding: 12px; text-align: center; font-size: 13px; color: #666;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th style="padding: 12px; text-align: center; font-size: 13px; color: #666;">ç· ã‚æ—¥æ™‚</th>
            </tr>
          </thead>
          <tbody>
            <% @closings.each do |closing| %>
              <tr style="border-bottom: 1px solid #f0f0f0;">
                <td style="padding: 12px; font-weight: 500;"><%= closing.period_display %></td>
                <td style="padding: 12px; text-align: right;"><%= closing.total_work_hours %>h</td>
                <td style="padding: 12px; text-align: right;"><%= closing.total_work_days %>æ—¥</td>
                <td style="padding: 12px; text-align: center;">
                  <span class="status-badge status-<%= closing.status %>">
                    <%= closing.status_display_name %>
                  </span>
                </td>
                <td style="padding: 12px; text-align: center; font-size: 13px; color: #666;">
                  <% if closing.closed_at %>
                    <%= closing.closed_at.strftime('%m/%d %H:%M') %>
                  <% else %>
                    -
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="text-align: center; padding: 40px; color: #666;">ç· ã‚å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <% end %>
    </div>

  <% else %>
    <!-- éƒ¨ç½²æ‹…å½“è€…ç”¨ï¼šæ‰¿èªå¾…ã¡ä¸€è¦§ -->
    <% if current_user.department_manager? && @pending_approvals.present? %>
      <div class="section-card">
        <div class="section-title">æ‰¿èªå¾…ã¡ã®æœˆæœ«ç· ã‚</div>

        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #e0e0e0;">
              <th style="padding: 12px; text-align: left; font-size: 13px; color: #666;">å¯¾è±¡æœˆ</th>
              <th style="padding: 12px; text-align: left; font-size: 13px; color: #666;">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
              <th style="padding: 12px; text-align: right; font-size: 13px; color: #666;">åŠ´åƒæ™‚é–“</th>
              <th style="padding: 12px; text-align: right; font-size: 13px; color: #666;">å‡ºå‹¤æ—¥æ•°</th>
              <th style="padding: 12px; text-align: center; font-size: 13px; color: #666;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <% @pending_approvals.each do |closing| %>
              <tr style="border-bottom: 1px solid #f0f0f0;">
                <td style="padding: 12px; font-weight: 500;"><%= closing.period_display %></td>
                <td style="padding: 12px;"><%= closing.user.display_name %></td>
                <td style="padding: 12px; text-align: right;"><%= closing.total_work_hours %>h</td>
                <td style="padding: 12px; text-align: right;"><%= closing.total_work_days %>æ—¥</td>
                <td style="padding: 12px; text-align: center;">
                  <%= button_to "æ‰¿èª", approve_month_end_closing_path(closing),
                                method: :post,
                                form: { data: { turbo_confirm: "#{closing.user.display_name}ã•ã‚“ã®#{closing.period_display}ã®æœˆæœ«ç· ã‚ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ" } },
                                class: "btn btn-success",
                                style: "display: inline-block; margin-right: 8px; padding: 6px 12px; font-size: 13px;" %>
                  <%= button_to "å´ä¸‹", reject_month_end_closing_path(closing),
                                method: :post,
                                form: { data: { turbo_confirm: "#{closing.user.display_name}ã•ã‚“ã®#{closing.period_display}ã®æœˆæœ«ç· ã‚ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ\nå´ä¸‹ã™ã‚‹ã¨ä½œæ¥­ä¸­ã«æˆ»ã‚Šã¾ã™ã€‚" } },
                                class: "btn btn-warning",
                                style: "display: inline-block; padding: 6px 12px; font-size: 13px;" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- éƒ¨ç½²æ‹…å½“è€…ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç”¨ï¼šãƒ¡ãƒ³ãƒãƒ¼ã®ç· ã‚çŠ¶æ³ä¸€è¦§ -->
    <div class="section-card">
      <div class="section-title"><%= @year %>å¹´<%= @month %>æœˆã®ç· ã‚çŠ¶æ³ä¸€è¦§</div>

      <% if @closings.any? %>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #e0e0e0;">
              <th style="padding: 12px; text-align: left; font-size: 13px; color: #666;">å¯¾è±¡æœˆ</th>
              <th style="padding: 12px; text-align: left; font-size: 13px; color: #666;">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
              <th style="padding: 12px; text-align: left; font-size: 13px; color: #666;">éƒ¨ç½²</th>
              <th style="padding: 12px; text-align: right; font-size: 13px; color: #666;">åŠ´åƒæ™‚é–“</th>
              <th style="padding: 12px; text-align: right; font-size: 13px; color: #666;">å‡ºå‹¤æ—¥æ•°</th>
              <th style="padding: 12px; text-align: center; font-size: 13px; color: #666;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th style="padding: 12px; text-align: center; font-size: 13px; color: #666;">æ‰¿èªè€…</th>
              <% if current_user.department_manager? %>
                <th style="padding: 12px; text-align: center; font-size: 13px; color: #666;">æ“ä½œ</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @closings.each do |closing| %>
              <tr style="border-bottom: 1px solid #f0f0f0;">
                <td style="padding: 12px;"><%= closing.period_display %></td>
                <td style="padding: 12px;"><%= closing.user.display_name %></td>
                <td style="padding: 12px;"><%= closing.user.department&.name || '-' %></td>
                <td style="padding: 12px; text-align: right;"><%= closing.total_work_hours %>h</td>
                <td style="padding: 12px; text-align: right;"><%= closing.total_work_days %>æ—¥</td>
                <td style="padding: 12px; text-align: center;">
                  <span class="status-badge status-<%= closing.status %>">
                    <%= closing.status_display_name %>
                  </span>
                </td>
                <td style="padding: 12px; text-align: center; font-size: 13px;">
                  <% if closing.closed_by %>
                    <%= closing.closed_by.display_name %>
                  <% else %>
                    -
                  <% end %>
                </td>
                <% if current_user.department_manager? %>
                  <td style="padding: 12px; text-align: center;">
                    <% if closing.can_reopen? %>
                      <%= button_to "å†é–‹", reopen_month_end_closing_path(closing),
                                    method: :post,
                                    form: { data: { turbo_confirm: "#{closing.user.display_name}ã•ã‚“ã®#{closing.period_display}ã®æœˆæœ«ç· ã‚ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ\nå†é–‹ã™ã‚‹ã¨ä½œæ¥­ä¸­ã«æˆ»ã‚Šã¾ã™ã€‚" } },
                                    class: "btn btn-secondary",
                                    style: "display: inline-block; padding: 6px 12px; font-size: 13px;" %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="text-align: center; padding: 40px; color: #666;">ç· ã‚çŠ¶æ³ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // æœˆé¸æŠã®å¤‰æ›´æ™‚ã«ãƒšãƒ¼ã‚¸é·ç§»
    const monthSelector = document.getElementById('month-selector');
    if (monthSelector) {
      monthSelector.addEventListener('change', function() {
        const [year, month] = this.value.split('-');
        window.location.href = `/month_end_closings?year=${year}&month=${month}`;
      });
    }

    // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½
    const checkboxes = document.querySelectorAll('.checklist-checkbox');
    const submitBtn = document.getElementById('submit-approval-btn');
    const warning = document.getElementById('checklist-warning');

    if (!submitBtn) return; // ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

    function checkAllChecked() {
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);

      if (allChecked) {
        submitBtn.style.pointerEvents = 'auto';
        submitBtn.style.opacity = '1';
        if (warning) warning.style.display = 'none';
      } else {
        submitBtn.style.pointerEvents = 'none';
        submitBtn.style.opacity = '0.5';
        if (warning) warning.style.display = 'block';
      }
    }

    checkboxes.forEach(cb => {
      cb.addEventListener('change', checkAllChecked);
    });

    // åˆæœŸçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    checkAllChecked();
  });
</script>
