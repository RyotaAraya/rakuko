<% content_for :title, "週間勤怠一覧 - 勤怠管理システム" %>

<%= render 'shared/header' %>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
  }
</style>

<div class="container">
  <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 20px;">
    週間勤怠一覧 <%= @start_date.strftime('%Y年%m月%d日') %> 〜 <%= @end_date.strftime('%m月%d日') %>
  </h2>

  <!-- 週ナビゲーション -->
  <div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <% prev_week_start = @start_date - 1.week %>
    <% next_week_start = @start_date + 1.week %>
    <% can_view_prev = current_user.within_contract_period?(prev_week_start) %>
    <% can_view_next = current_user.within_contract_period?(next_week_start) %>

    <% if can_view_prev %>
      <%= link_to "← 前週", weekly_attendances_path(start_date: prev_week_start),
          style: "padding: 8px 16px; border: 1px solid #ccc; background: white; text-decoration: none; color: black;" %>
    <% else %>
      <span style="padding: 8px 16px; border: 1px solid #ccc; background: #f5f5f5; color: #999; cursor: not-allowed;">← 前週</span>
    <% end %>

    <%= link_to "今週", weekly_attendances_path,
        style: "padding: 8px 16px; border: 1px solid #ccc; background: white; text-decoration: none; color: black;" %>

    <% if can_view_next %>
      <%= link_to "次週 →", weekly_attendances_path(start_date: next_week_start),
          style: "padding: 8px 16px; border: 1px solid #ccc; background: white; text-decoration: none; color: black;" %>
    <% else %>
      <span style="padding: 8px 16px; border: 1px solid #ccc; background: #f5f5f5; color: #999; cursor: not-allowed;">次週 →</span>
    <% end %>
  </div>

  <!-- 週間サマリー -->
  <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <div style="font-weight: bold; margin-bottom: 15px; font-size: 16px;">週間集計</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
      <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">総労働時間</div>
        <div style="font-size: 24px; font-weight: bold;"><%= @week_summary[:total_hours].to_f.round(1) %>h</div>
      </div>
      <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">出勤日数</div>
        <div style="font-size: 24px; font-weight: bold;"><%= @week_summary[:total_days] %>日</div>
      </div>
      <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">平均労働時間</div>
        <div style="font-size: 24px; font-weight: bold;"><%= @week_summary[:avg_hours].to_f.round(1) %>h</div>
      </div>
    </div>
    <% if @week_summary[:total_hours].to_f > 20 %>
      <div style="margin-top: 15px; padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c00;">
        ⚠️ 週の労働時間が20時間制限を超過しています
      </div>
    <% else %>
      <div style="margin-top: 15px; padding: 10px; background: #efe; border: 1px solid #cfc; border-radius: 4px; color: #060;">
        ✓ 週の労働時間は制限内です
      </div>
    <% end %>
  </div>

  <!-- 日別勤怠一覧 -->
  <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
    <div style="font-weight: bold; margin-bottom: 15px; font-size: 16px;">日別勤怠</div>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="border: 1px solid #ddd; padding: 10px; background: #f5f5f5; text-align: left;">日付</th>
          <th style="border: 1px solid #ddd; padding: 10px; background: #f5f5f5; text-align: center;">労働時間</th>
          <th style="border: 1px solid #ddd; padding: 10px; background: #f5f5f5; text-align: center;">休憩時間</th>
        </tr>
      </thead>
      <tbody>
        <% (@start_date..@end_date).each do |date| %>
          <% attendance = @attendances.find { |a| a.date == date } %>
          <tr>
            <td style="border: 1px solid #ddd; padding: 10px;">
              <%= date.strftime('%Y/%m/%d (%a)') %>
            </td>
            <% if attendance %>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">
                <%= attendance.work_hours_display %>
              </td>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">
                <%= attendance.break_time_display %>
              </td>
            <% else %>
              <td colspan="2" style="border: 1px solid #ddd; padding: 10px; text-align: center; color: #999;">
                勤怠記録なし
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
