<% content_for :title, "勤怠管理システム" %>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #fafafa;
  }
  .header {
    border-bottom: 1px solid #ddd;
    padding: 15px 0;
    background: white;
  }
  .header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
  }
  .header h1 {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
  }
  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .logout-btn {
    padding: 8px 16px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    color: black;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
  }
  .status-section {
    border: 1px solid #ddd;
    padding: 20px;
    margin-bottom: 30px;
    background: white;
  }
  .status-title {
    font-weight: bold;
    margin-bottom: 10px;
  }
  .progress-bar {
    background: #f0f0f0;
    height: 8px;
    margin-top: 10px;
  }
  .progress-fill {
    background: #007cba;
    height: 100%;
    width: 68%;
  }
  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  .menu-item {
    border: 1px solid #ddd;
    padding: 20px;
    background: white;
    cursor: pointer;
    text-decoration: none;
    color: black;
  }
  .menu-item:hover {
    background: #f5f5f5;
  }
  .menu-title {
    font-weight: bold;
    margin-bottom: 5px;
  }
  .menu-desc {
    font-size: 12px;
    color: #666;
  }
  .today-section {
    border: 1px solid #ddd;
    padding: 20px;
    background: white;
  }
  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  .btn {
    padding: 8px 16px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    color: black;
  }
  .btn-primary {
    background: #007cba;
    color: white;
    border-color: #007cba;
  }
</style>

<% if user_signed_in? %>
  <!-- ヘッダー -->
  <header class="header">
    <div class="header-content">
      <h1>勤怠管理システム</h1>
      <div class="user-info">
        <span style="font-size: 14px;"><%= current_user.display_name %></span>
        <%= link_to "ログアウト", destroy_user_session_path, class: "logout-btn" %>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container">
    <!-- 労働時間制限警告 -->
    <% if @week_violations && @week_violations[:has_violations] %>
      <div style="margin-bottom: 20px;">
        <% @week_violations[:violations].each do |violation| %>
          <div style="padding: 15px; margin-bottom: 10px; border-radius: 4px; <%= violation[:severity] == 'error' ? 'background: #fee; border: 1px solid #fcc; color: #c00;' : 'background: #ffc; border: 1px solid #ffb; color: #860;' %>">
            <strong><%= violation[:severity] == 'error' ? '⚠️ 労働時間制限超過' : '⚠️ 労働時間制限警告' %></strong><br>
            <%= violation[:message] %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- ステータス表示 -->
    <div class="status-section">
      <div class="status-title">労働時間状況</div>
      <% if @week_violations %>
        <% breakdown = @week_violations[:breakdown] %>
        <div>今週（弊社）: <%= breakdown[:actual_company_hours] %>h / <%= breakdown[:company_limit] %>h</div>
        <div>今週（掛け持ち）: <%= breakdown[:actual_sidejob_hours] %>h</div>
        <div>合計予測: <%= breakdown[:predicted_total_hours] %>h / <%= breakdown[:total_limit] %>h</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: <%= [breakdown[:predicted_total_hours] / breakdown[:total_limit] * 100, 100].min %>%"></div>
        </div>
      <% else %>
        <div>今週: 12.5h/20h　掛け持ち: 15h</div>
        <div>合計: 27.5h/40h</div>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      <% end %>
    </div>

    <!-- 機能メニュー -->
    <div class="menu-grid">
      <%= link_to new_shift_request_path, class: "menu-item" do %>
        <div class="menu-title">シフト希望提出</div>
        <div class="menu-desc">月間予定を入力</div>
      <% end %>
      <%= link_to today_attendances_path, class: "menu-item" do %>
        <div class="menu-title">勤怠登録</div>
        <div class="menu-desc">出退勤を記録</div>
      <% end %>
      <%= link_to new_application_path, class: "menu-item" do %>
        <div class="menu-title">各種申請</div>
        <div class="menu-desc">欠勤・遅刻・早退</div>
      <% end %>
      <a href="#" class="menu-item">
        <div class="menu-title">月末締め作業</div>
        <div class="menu-desc">外部ツール連携</div>
      </a>
      <a href="#" class="menu-item">
        <div class="menu-title">申請履歴確認</div>
        <div class="menu-desc">状況確認</div>
      </a>
    </div>

    <!-- 今日の勤怠登録 -->
    <div id="home-attendance-app" data-date="<%= Date.current.iso8601 %>">
      <!-- Loading fallback -->
      <div id="home-loading-message" style="text-align: center; padding: 40px;">
        <p>勤怠画面を読み込み中...</p>
      </div>
    </div>
  </main>
<% else %>
  <!-- ログイン前の表示 -->
  <div style="text-align: center; padding: 50px;">
    <h2>学生アルバイト勤怠管理システム</h2>
    <p>ログインしてください</p>
    <%= button_to "Googleでログイン", user_google_oauth2_omniauth_authorize_path, method: :post, class: "btn btn-primary", data: { turbo: false } %>

    <% unless Rails.env.production? %>
      <div style="margin-top: 20px;">
        <%= link_to "開発用ログイン", new_user_session_path, class: "btn" %>
      </div>
    <% end %>
  </div>
<% end %>
