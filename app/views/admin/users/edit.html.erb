<% content_for :title, "ユーザー編集" %>

<%= render 'shared/header' %>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- ヘッダー -->
    <div class="mb-8">
      <div class="flex items-center space-x-4 mb-4">
        <%= link_to admin_user_path(@user), class: "text-blue-600 hover:text-blue-900" do %>
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        <% end %>
        <h1 class="text-3xl font-bold text-gray-900">ユーザー編集</h1>
      </div>
      <p class="mt-2 text-gray-600"><%= @user.display_name %>さんの情報を編集</p>
    </div>

    <!-- ステータスバッジ -->
    <div class="mb-6">
      <% case @user.status %>
      <% when 'pending' %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
          </svg>
          承認待ち
        </span>
      <% when 'active' %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          有効
        </span>
      <% when 'inactive' %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          無効
        </span>
      <% end %>
    </div>

    <!-- エラー表示 -->
    <% if flash[:alert] %>
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">
              <%= flash[:alert] %>
            </h3>
          </div>
        </div>
      </div>
    <% end %>

    <% if @user.errors.any? %>
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">
              <%= pluralize(@user.errors.count, "個のエラー") %>があります
            </h3>
            <div class="mt-2 text-sm text-red-700">
              <ul class="list-disc pl-5 space-y-1">
                <% @user.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <%= form_with model: [:admin, @user] do |form| %>
      <!-- 基本情報 -->
      <div class="bg-white shadow sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">基本情報</h3>
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <!-- 姓 -->
            <div>
              <%= form.label :last_name, "姓", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field :last_name, class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
            </div>

            <!-- 名 -->
            <div>
              <%= form.label :first_name, "名", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field :first_name, class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
            </div>

            <!-- メールアドレス（読み取り専用） -->
            <div class="sm:col-span-2">
              <%= form.label :email, "メールアドレス", class: "block text-sm font-medium text-gray-700" %>
              <div class="mt-1 block w-full border border-gray-200 rounded-md shadow-sm py-2 px-3 bg-gray-50 text-gray-500 sm:text-sm">
                <%= @user.email %>
              </div>
              <p class="mt-1 text-xs text-gray-500">メールアドレスは変更できません</p>
            </div>

            <!-- 部署 -->
            <div>
              <%= form.label :department_id, "所属部署", class: "block text-sm font-medium text-gray-700" %>
              <%= form.select :department_id,
                              options_from_collection_for_select(@departments, :id, :name, @user.department_id),
                              { include_blank: "部署を選択してください" },
                              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
            </div>

            <!-- 権限（読み取り専用表示） -->
            <div>
              <label class="block text-sm font-medium text-gray-700">権限</label>
              <div class="mt-1 text-sm text-gray-900">
                <% if @user.roles.any? %>
                  <div class="flex flex-wrap gap-2">
                    <% @user.roles.each do |role| %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <%= role.display_name %>
                      </span>
                    <% end %>
                  </div>
                <% else %>
                  未設定
                <% end %>
              </div>
            </div>
          </div>

          <!-- 権限設定 -->
          <div class="mt-6">
            <fieldset>
              <legend class="block text-sm font-medium text-gray-700 mb-2">権限（1つ選択）</legend>
              <div class="space-y-3">
                <% @roles.each do |role| %>
                  <div class="relative flex items-start">
                    <div class="flex items-center h-5">
                      <%= radio_button_tag "user[role_id]",
                                           role.id,
                                           @user.roles.include?(role) || (@user.pending? && !@user.roles.any? && role.name == 'student'),
                                           id: "role_#{role.id}",
                                           class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300" %>
                    </div>
                    <div class="ml-3 text-sm">
                      <%= label_tag "role_#{role.id}", class: "font-medium text-gray-700" do %>
                        <%= role.display_name %>
                        <span class="text-gray-500 font-normal block mt-1">
                          <%= role_description(role.name) %>
                        </span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </fieldset>
            <% if @user.pending? && !@user.roles.any? %>
              <p class="mt-2 text-xs text-gray-500">承認待ちユーザーは「アルバイト」がデフォルトで選択されています</p>
            <% end %>
          </div>
        </div>
      </div>

      <!-- 契約情報（アルバイトのみ） -->
      <div id="contract-section">
        <div class="bg-white shadow sm:rounded-lg mb-6">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">契約情報</h3>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <label class="block text-sm font-medium text-gray-700">契約開始日</label>
                <div class="mt-1 text-sm text-gray-900"><%= @user.created_at.strftime('%Y年%m月%d日') %></div>
              </div>
              <div>
                <%= form.label :contract_end_date, "契約終了日", class: "block text-sm font-medium text-gray-700" %>
                <%= form.date_field :contract_end_date,
                                    class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- システム情報 -->
      <div class="bg-white shadow sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">システム情報</h3>
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-gray-700">登録日時</label>
              <div class="mt-1 text-sm text-gray-900"><%= @user.created_at.strftime('%Y年%m月%d日 %H:%M') %></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">最終更新</label>
              <div class="mt-1 text-sm text-gray-900"><%= @user.updated_at.strftime('%Y年%m月%d日 %H:%M') %></div>
            </div>
          </div>
        </div>
      </div>

      <!-- アカウントステータス -->
      <div class="bg-white shadow sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">アカウントステータス</h3>
          <%= form.label :status, "ステータス", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :status,
                          [["有効", "active"], ["無効", "inactive"]],
                          {},
                          class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
          <p class="mt-1 text-xs text-gray-500">アカウントの有効/無効を設定できます</p>
        </div>
      </div>

      <!-- フッター（アクションボタン） -->
      <div class="flex justify-end space-x-3">
        <%= link_to admin_user_path(@user), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
          キャンセル
        <% end %>
        <%= form.submit "保存", class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function initContractSection() {
    const roleRadios = document.querySelectorAll('input[name="user[role_id]"]');
    const contractSection = document.getElementById('contract-section');
    const studentRoleId = <%= @roles.find { |r| r.name == 'student' }&.id || 'null' %>;

    if (!contractSection) {
      console.error('contract-section not found');
      return;
    }

    if (!studentRoleId) {
      console.error('student role not found');
      return;
    }

    function toggleContractSection() {
      const selectedRole = document.querySelector('input[name="user[role_id]"]:checked');
      console.log('Selected role:', selectedRole ? selectedRole.value : 'none');
      console.log('Student role ID:', studentRoleId);

      if (selectedRole && parseInt(selectedRole.value) === studentRoleId) {
        console.log('Showing contract section');
        contractSection.style.display = 'block';
      } else {
        console.log('Hiding contract section');
        contractSection.style.display = 'none';
      }
    }

    // イベントリスナーを削除してから追加（重複防止）
    roleRadios.forEach(radio => {
      const newRadio = radio.cloneNode(true);
      radio.parentNode.replaceChild(newRadio, radio);
    });

    // 再取得したラジオボタンにイベントリスナーを追加
    document.querySelectorAll('input[name="user[role_id]"]').forEach(radio => {
      radio.addEventListener('change', function() {
        console.log('Role changed to:', this.value);
        toggleContractSection();
      });
    });

    // 初期表示
    console.log('Initializing contract section');
    toggleContractSection();
  }

  document.addEventListener('DOMContentLoaded', initContractSection);
  document.addEventListener('turbo:load', initContractSection);
  document.addEventListener('turbo:render', initContractSection);
  document.addEventListener('turbo:frame-render', initContractSection);
</script>
